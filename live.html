<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio · Swing Notes</title>
  <link rel="stylesheet" href="live.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Portfolio Tracker — Trades Abertos</h1>
      <div id="updated" class="updated"></div>
    </header>

    <div class="top-menu">
      <select id="sort" class="sort" aria-label="Ordenação">
        <option value="var_desc">Variação (%) — maior primeiro</option>
        <option value="var_asc">Variação (%) — menor primeiro</option>
        <option value="dias_desc">Dias abertos — maior primeiro</option>
        <option value="dias_asc">Dias abertos — menor primeiro</option>
      </select>
      <input id="q" class="search" placeholder="Filtrar por ticker…" />
    </div>

    <!-- 4 CARDS DE RESUMO -->
    <div id="portfolio-summary" class="sn-summary-grid">
      <div class="sn-summary-card">
        <div class="sn-summary-label">Valor Investido</div>
        <div class="sn-summary-value" id="summary-invested">$0.00</div>
      </div>
      <div class="sn-summary-card">
        <div class="sn-summary-label">Valor Atual</div>
        <div class="sn-summary-value" id="summary-current">$0.00</div>
      </div>
      <div class="sn-summary-card">
        <div class="sn-summary-label">PnL (USD)</div>
        <div class="sn-summary-value" id="summary-pnl-usd">$0.00</div>
      </div>
      <div class="sn-summary-card">
        <div class="sn-summary-label">PnL (%)</div>
        <div class="sn-summary-value" id="summary-pnl-pct">0.00%</div>
      </div>
    </div>

    <!-- GRID DE TICKERS -->
    <section id="mount">
      <div class="empty">Carregando…</div>
    </section>

    <footer>
      Dica: use a busca para filtrar por ticker.
    </footer>
  </div>

  <script>
    // Arquivos com as posições abertas por projeto
    const DATA_URLS = [
      "/data/abertos_swingnotes.json",
      "/data/abertos_countdown.json",
      "/data/abertos_minimumwage.json"
    ];

    async function fetchJSON(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok){
        console.warn("Falha ao buscar:", url, res.status);
        throw new Error("fetch fail " + url);
      }
      return res.json();
    }

    const $ = (sel, el=document)=> el.querySelector(sel);

    function fmtMoney(x){
      const n = Number(x);
      return isFinite(n) ? "$" + n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : "—";
    }
    function fmtQty(x){
      const n = Number(x);
      return isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:8,maximumFractionDigits:8}) : "—";
    }
    function fmtPct(x){
      const n = Number(x);
      if(!isFinite(n)) return "—";
      return (n>=0?"+":"") + n.toFixed(2) + "%";
    }
    const classForPct = n => Number(n) >= 0 ? "pos" : "neg";

    function lastFiveStamp(d = new Date()){
      d = new Date(d);
      d.setSeconds(0, 0);
      d.setMinutes(Math.floor(d.getMinutes()/5)*5);
      const pad = n => String(n).padStart(2, "0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    let STATE = { rows: [], q: "", sort: "var_desc" };

    function toNum(v){
      if(v === null || v === undefined || v === "") return NaN;
      const s = String(v).trim().replace(/[%\s]/g,'').replace(/,/g,'');
      const n = Number(s);
      return isNaN(n) ? NaN : n;
    }

    // Normaliza campos vindos dos JSONs
    function normalize(rows){
      return rows.map(r=>({
        ticker: (r.ticker ?? r.Ticker ?? "").toString().toUpperCase(),
        dias_aberto: toNum(r.dias_aberto ?? r["Dias Aberto"] ?? r.dias ?? 0),
        quantidade: toNum(r.quantidade ?? r.Quantidade ?? r.qty ?? 0),
        preco_entrada: toNum(r.preco_entrada ?? r.Preco_Entrada ?? r.preco_entrada_unit ?? r.preco_entrada_un ?? r.entry ?? 0),
        preco_atual: toNum(r.preco_atual ?? r.Preco_Atual ?? r.last_close ?? r.close ?? 0),
        variacao_pct: toNum(r.variacao_pct ?? r["Variação (%)"] ?? r.var_pct ?? r.ChangePct ?? 0),
      }));
    }

    function optionalLevels(r){
      const keys = [
        ["sl_agressivo","SL Agressivo"], ["sl_tecnico","SL Técnico"], ["sl_conservador","SL Conservador"],
        ["tp_agressivo","TP Agressivo"], ["tp_tecnico","TP Técnico"], ["tp_conservador","TP Conservador"],
      ];
      const out = [];
      for(const [k,label] of keys){
        if(k in r && r[k] !== null && r[k] !== undefined && !Number.isNaN(r[k])){
          out.push(`<div class="row"><span class="k">${label}</span><span class="v">${fmtMoney(r[k])}</span></div>`);
        }
      }
      return out.join("");
    }

    // === RESUMO DO PORTFÓLIO (4 CARDS) ===
    function renderPortfolioSummaryFrom(rows){
      const invested = rows.reduce((acc,r)=>{
        const q = Number(r.quantidade); const pe = Number(r.preco_entrada);
        return acc + (isFinite(q)&&isFinite(pe) ? q*pe : 0);
      }, 0);
      const current  = rows.reduce((acc,r)=>{
        const q = Number(r.quantidade); const pa = Number(r.preco_atual);
        return acc + (isFinite(q)&&isFinite(pa) ? q*pa : 0);
      }, 0);
      const pnlUsd = current - invested;
      const pnlPct = invested ? (pnlUsd / invested) * 100 : 0;

      const investedEl = $("#summary-invested");
      const currentEl  = $("#summary-current");
      const pnlUsdEl   = $("#summary-pnl-usd");
      const pnlPctEl   = $("#summary-pnl-pct");

      if(!investedEl || !currentEl || !pnlUsdEl || !pnlPctEl) return;

      investedEl.textContent = fmtMoney(invested);
      currentEl.textContent  = fmtMoney(current);
      pnlUsdEl.textContent   = fmtMoney(pnlUsd);
      pnlPctEl.textContent   = fmtPct(pnlPct);

      pnlUsdEl.className = "sn-summary-value " + (pnlUsd >= 0 ? "pos" : "neg");
      pnlPctEl.className = "sn-summary-value " + (pnlPct >= 0 ? "pos" : "neg");
    }

    function render(){
      const mount = document.getElementById("mount");
      const q = STATE.q.trim().toUpperCase();
      let rows = STATE.rows.slice();

      if(q){ rows = rows.filter(r => (r.ticker||"").toUpperCase().includes(q)); }

      switch(STATE.sort){
        case "var_asc": rows.sort((a,b)=> Number(a.variacao_pct) - Number(b.variacao_pct)); break;
        case "var_desc": rows.sort((a,b)=> Number(b.variacao_pct) - Number(a.variacao_pct)); break;
        case "dias_asc": rows.sort((a,b)=> Number(a.dias_aberto) - Number(b.dias_aberto)); break;
        case "dias_desc": rows.sort((a,b)=> Number(b.dias_aberto) - Number(a.dias_aberto)); break;
      }

      if(!rows.length){
        mount.innerHTML = `<div class="empty">Nenhuma posição aberta.</div>`;
        renderPortfolioSummaryFrom(STATE.rows);
        return;
      }

      const html = [`<div class="grid">`];
      for(const r of rows){
        const vp = Number(r.variacao_pct);
        html.push(`
          <article class="card" aria-label="${r.ticker}">
            <h3>
              <span>${r.ticker || "—"}</span>
              <span class="badge">${Number(r.dias_aberto)||0}d</span>
            </h3>
            <div class="rows">
              <div class="row"><span class="k">Quantidade</span><span class="v">${fmtQty(r.quantidade)}</span></div>
              <div class="row"><span class="k">Preço de entrada</span><span class="v">${fmtMoney(r.preco_entrada)}</span></div>
              <div class="row"><span class="k">Preço atual</span><span class="v">${fmtMoney(r.preco_atual)}</span></div>
              <div class="row"><span class="k">Variação</span><span class="v ${classForPct(vp)}">${fmtPct(vp)}</span></div>
              ${optionalLevels(r)}
            </div>
          </article>`);
      }
      html.push(`</div>`);
      mount.innerHTML = html.join("");

      // resumo sempre reflete TODAS as posições carregadas
      renderPortfolioSummaryFrom(STATE.rows);
    }

    async function loadAll(){
      const mount = document.getElementById("mount");
      mount.innerHTML = `<div class="empty">Carregando dados…</div>`;
      try{
        const results = await Promise.all(DATA_URLS.map(u => fetchJSON(u).catch(()=>[])));
        const merged = results.flatMap(j => Array.isArray(j) ? j : (j && Array.isArray(j.rows) ? j.rows : []));
        STATE.rows = normalize(merged);
        document.getElementById("updated").textContent = `Atualizado a cada 5' (${lastFiveStamp()})`;
        render();
      }catch(e){
        mount.innerHTML = `<div class="empty">Falha ao carregar dados.</div>`;
        console.error(e);
      }
    }

    // Listeners
    document.getElementById("q").addEventListener("input", ev=>{ STATE.q = ev.target.value; render(); });
    document.getElementById("sort").addEventListener("change", ev=>{ STATE.sort = ev.target.value; render(); });

    // Boot
    loadAll();
  </script>
</body>
</html>
