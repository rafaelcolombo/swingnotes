<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio · Swing Notes</title>

  <style>
  /* ===========================
     SwingNotes — Dark layout (Live + Index)
     =========================== */
  :root{
    --bg:#0b0f14;
    --card:#121821;
    --ink:#e6edf3;
    --muted:#9aa7b2;
    --pos:#1ecb7b;
    --neg:#ff6b6b;
    --brand:#f59e0b;
    --ring:#223042;
    --chip:#1b2430;
    --text: var(--ink);
  }

  *{ box-sizing:border-box }

  html, body{
    height:100%;
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--ink);
    font:16px/1.6 system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial,sans-serif;
  }

  /* ====== LAYOUT ====== */
  .container{ max-width:1100px; margin:0 auto; padding:28px 20px }
  .muted{ color:var(--muted) }
  .updated{ font-size:.9rem; color:var(--muted); opacity:.7 }

  /* ====== UTILS ====== */
  .pos{ color:var(--pos) }
  .neg{ color:var(--neg) }

  /* ====== HEADER ====== */
  header{
    background:none;
    border:none;
    box-shadow:none;
    margin:0 0 10px;
    padding:0;
    display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
  }
  header h1{
    font-size:2rem;
    font-weight:800;
    margin:0;
    color:var(--ink);
  }

  /* ====== MENU SUPERIOR ====== */
  .top-menu{
    display:flex;
    gap:10px;
    margin: 8px 0 14px;
    align-items:center;
    flex-wrap:wrap;
  }
  .sort{
    background:var(--card);
    border:1px solid var(--ring);
    color:var(--ink);
    border-radius:10px;
    padding:8px 10px;
  }
  .search{
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:10px;
    padding:8px 10px;
    color:var(--ink);
    width:220px;
  }
  @media (max-width:560px){ .search{ width:100% } }

  /* ====== SUMMARY GRID (4 cards do topo) ====== */
  .sn-summary-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
    gap:12px;
    margin:16px 0 18px;
  }
  .sn-summary-card{
    background:var(--card);
    border-radius:16px;
    padding:12px 16px;
    box-shadow:0 0 0 1px var(--ring);
    text-align:center;
  }
  .sn-summary-label{ color:var(--muted); font-size:13px; }
  .sn-summary-value{ font-size:18px; font-weight:600; margin-top:4px; }
  .sn-summary-value.pos{ color:var(--pos); }
  .sn-summary-value.neg{ color:var(--neg); }

  /* ====== SEÇÕES ====== */
  section, footer{
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:16px;
    padding:14px 18px;
    box-shadow:0 6px 18px rgba(0,0,0,.18);
    margin-bottom:16px;
  }

  /* ====== CARDS BASE ====== */
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border:1px solid var(--ring);
    border-radius:18px;
    padding:12px 14px;
    box-shadow:0 10px 26px rgba(0,0,0,.55);
    backdrop-filter:blur(6px);
  }

  /* ====== GRID genérico (cards de tickers) ====== */
  .grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px }
  .badge{ font-size:11px; padding:2px 6px; border-radius:999px; background:var(--chip); border:1px solid var(--ring); color:var(--muted) }
  .rows{ display:grid; gap:6px; margin-top:6px }
  .row{ display:flex; justify-content:space-between; gap:8px }
  .k{ color:var(--muted); font-size:12px; opacity:.9 }
  .v{ font-weight:700 }
  .empty{ border:1px dashed var(--ring); padding:18px; border-radius:12px; color:var(--muted); text-align:center }

  /* ====== SELL SUMMARY GRID — escopado (se usar) ====== */
  #sell-cards .sn-summary-grid{
    display:grid;
    gap:12px;
    margin-top:8px;
    grid-template-columns:repeat(2, minmax(260px, 1fr));
    grid-template-areas:
      "ultimo ultimo"
      "melhor ultimo_profit"
      "pior   ultimo_loss";
  }
  @media (max-width:900px){
    #sell-cards .sn-summary-grid{
      grid-template-columns:1fr;
      grid-template-areas:
        "ultimo"
        "melhor"
        "ultimo_profit"
        "pior"
        "ultimo_loss";
    }
  }
  .sn-card.ultimo{ grid-area:ultimo }
  .sn-card.melhor{ grid-area:melhor }
  .sn-card.ultimo_profit{ grid-area:ultimo_profit }
  .sn-card.pior{ grid-area:pior }
  .sn-card.ultimo_loss{ grid-area:ultimo_loss }

  .sn-head{ display:flex; align-items:center; gap:8px; font-weight:600; font-size:.98rem; letter-spacing:.2px }
  .sn-icon{ font-size:1.05rem }
  .sn-row{ margin-top:8px; font-size:.92rem; line-height:1.35rem }

  /* chips */
  .sn-chip{
    display:inline-block; padding:2px 8px; border-radius:999px;
    font-size:.78rem; font-weight:600; margin-right:6px; margin-bottom:6px;
    border:1px solid var(--ring);
    background:rgba(255,255,255,.06);
    color:var(--ink);
    word-break:break-word;
  }

  /* estados */
  .sn-pnl-pos,.sn-pos{ color:var(--pos); font-weight:700 }
  .sn-pnl-neg,.sn-neg{ color:var(--neg); font-weight:700 }
  .sn-tkr{ font-weight:700 }
  .sn-muted{ opacity:.8; color:var(--muted) }

  /* ====== PROJECT SUMMARY GRID — live (se usar) ====== */
  .sn-proj-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    gap:12px;
    margin:8px 0 22px 0;
  }
  .sn-metric-head{ font-size:.86rem; opacity:.85; margin-bottom:6px }
  .sn-metric-value{ font-size:1.15rem; font-weight:800; letter-spacing:.2px }

  footer{
    text-align:center;
    color:var(--muted);
    font-size:.85rem;
    opacity:.7;
  }
  a{ color:var(--pos); text-decoration:none }
  a:hover{ text-decoration:underline }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Portfolio Tracker — Trades Abertos</h1>
      <div id="updated" class="updated"></div>
    </header>

    <div class="top-menu">
      <select id="sort" class="sort" aria-label="Ordenação">
        <option value="var_desc">Variação (%) — maior primeiro</option>
        <option value="var_asc">Variação (%) — menor primeiro</option>
        <option value="dias_desc">Dias abertos — maior primeiro</option>
        <option value="dias_asc">Dias abertos — menor primeiro</option>
      </select>
      <input id="q" class="search" placeholder="Filtrar por ticker…" />
    </div>

    <!-- 4 CARDS DE RESUMO -->
    <div id="portfolio-summary" class="sn-summary-grid">
      <div class="sn-summary-card">
        <div class="sn-summary-label">Valor Investido</div>
        <div class="sn-summary-value" id="summary-invested">$0.00</div>
      </div>
      <div class="sn-summary-card">
        <div class="sn-summary-label">Valor Atual</div>
        <div class="sn-summary-value" id="summary-current">$0.00</div>
      </div>
      <div class="sn-summary-card">
        <div class="sn-summary-label">PnL (USD)</div>
        <div class="sn-summary-value" id="summary-pnl-usd">$0.00</div>
      </div>
      <div class="sn-summary-card">
        <div class="sn-summary-label">PnL (%)</div>
        <div class="sn-summary-value" id="summary-pnl-pct">0.00%</div>
      </div>
    </div>

    <!-- GRID DE TICKERS -->
    <section id="mount">
      <div class="empty">Carregando…</div>
    </section>

    <footer>
      Dica: use a busca para filtrar por ticker.
    </footer>
  </div>

  <script>
    // ---- CONFIG: arquivos com as posições por projeto
    const DATA_URLS = [
      "/data/abertos_swingnotes.json",
      "/data/abertos_countdown.json",
      "/data/abertos_minimumwage.json"
    ];

    async function fetchJSON(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok){ throw new Error("fetch fail " + url + " [" + res.status + "]"); }
      return res.json();
    }

    const $ = (sel, el=document)=> el.querySelector(sel);

    function fmtMoney(x){
      const n = Number(x);
      return isFinite(n) ? "$" + n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : "—";
    }
    function fmtQty(x){
      const n = Number(x);
      return isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:8,maximumFractionDigits:8}) : "—";
    }
    function fmtPct(x){
      const n = Number(x);
      return isFinite(n) ? ((n>=0?"+":"") + n.toFixed(2) + "%") : "—";
    }
    const classForPct = n => Number(n) >= 0 ? "pos" : "neg";

    function lastFiveStamp(d = new Date()){
      d = new Date(d);
      d.setSeconds(0, 0);
      d.setMinutes(Math.floor(d.getMinutes()/5)*5);
      const pad = n => String(n).padStart(2, "0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    let STATE = { rows: [], q: "", sort: "var_desc" };

    function toNum(v){
      if(v === null || v === undefined || v === "") return NaN;
      // remove espaços, % e vírgulas de milhar
      const s = String(v).trim().replace(/[%\s]/g,'').replace(/,/g,'');
      const n = Number(s);
      return isNaN(n) ? NaN : n;
    }

    // Normaliza campos vindos dos JSONs
    function normalize(rows){
      return rows.map(r=>({
        ticker: (r.ticker ?? r.Ticker ?? "").toString().toUpperCase(),
        dias_aberto: toNum(r.dias_aberto ?? r["Dias Aberto"] ?? r.dias ?? 0),
        quantidade: toNum(r.quantidade ?? r.Quantidade ?? r.qty ?? 0),
        preco_entrada: toNum(r.preco_entrada ?? r.Preco_Entrada ?? r.preco_entrada_unit ?? r.preco_entrada_un ?? r.entry ?? 0),
        preco_atual: toNum(r.preco_atual ?? r.Preco_Atual ?? r.last_close ?? r.close ?? 0),
        variacao_pct: toNum(r.variacao_pct ?? r["Variação (%)"] ?? r.var_pct ?? r.ChangePct ?? 0),
      }));
    }

    function optionalLevels(r){
      const keys = [
        ["sl_agressivo","SL Agressivo"], ["sl_tecnico","SL Técnico"], ["sl_conservador","SL Conservador"],
        ["tp_agressivo","TP Agressivo"], ["tp_tecnico","TP Técnico"], ["tp_conservador","TP Conservador"],
      ];
      const out = [];
      for(const [k,label] of keys){
        if(k in r && r[k] !== null && r[k] !== undefined && !Number.isNaN(r[k])){
          out.push(`<div class="row"><span class="k">${label}</span><span class="v">${fmtMoney(r[k])}</span></div>`);
        }
      }
      return out.join("");
    }

    // === RESUMO DO PORTFÓLIO (4 CARDS) ===
    function renderPortfolioSummaryFrom(rows){
      const invested = rows.reduce((acc,r)=>{
        const q = Number(r.quantidade); const pe = Number(r.preco_entrada);
        return acc + (isFinite(q)&&isFinite(pe) ? q*pe : 0);
      }, 0);
      const current  = rows.reduce((acc,r)=>{
        const q = Number(r.quantidade); const pa = Number(r.preco_atual);
        return acc + (isFinite(q)&&isFinite(pa) ? q*pa : 0);
      }, 0);
      const pnlUsd = current - invested;
      const pnlPct = invested ? (pnlUsd / invested) * 100 : 0;

      const investedEl = $("#summary-invested");
      const currentEl  = $("#summary-current");
      const pnlUsdEl   = $("#summary-pnl-usd");
      const pnlPctEl   = $("#summary-pnl-pct");

      investedEl.textContent = fmtMoney(invested);
      currentEl.textContent  = fmtMoney(current);
      pnlUsdEl.textContent   = fmtMoney(pnlUsd);
      pnlPctEl.textContent   = fmtPct(pnlPct);

      pnlUsdEl.className = "sn-summary-value " + (pnlUsd >= 0 ? "pos" : "neg");
      pnlPctEl.className = "sn-summary-value " + (pnlPct >= 0 ? "pos" : "neg");
    }

    function render(){
      const mount = document.getElementById("mount");
      const q = STATE.q.trim().toUpperCase();
      let rows = STATE.rows.slice();

      if(q){ rows = rows.filter(r => (r.ticker||"").toUpperCase().includes(q)); }

      switch(STATE.sort){
        case "var_asc": rows.sort((a,b)=> Number(a.variacao_pct) - Number(b.variacao_pct)); break;
        case "var_desc": rows.sort((a,b)=> Number(b.variacao_pct) - Number(a.variacao_pct)); break;
        case "dias_asc": rows.sort((a,b)=> Number(a.dias_aberto) - Number(b.dias_aberto)); break;
        case "dias_desc": rows.sort((a,b)=> Number(b.dias_aberto) - Number(a.dias_aberto)); break;
      }

      if(!rows.length){
        mount.innerHTML = `<div class="empty">Nenhuma posição aberta.</div>`;
        renderPortfolioSummaryFrom(STATE.rows);
        return;
      }

      const html = [`<div class="grid">`];
      for(const r of rows){
        const vp = Number(r.variacao_pct);
        html.push(`
          <article class="card" aria-label="${r.ticker}">
            <h3>
              <span>${r.ticker || "—"}</span>
              <span class="badge">${Number(r.dias_aberto)||0}d</span>
            </h3>
            <div class="rows">
              <div class="row"><span class="k">Quantidade</span><span class="v">${fmtQty(r.quantidade)}</span></div>
              <div class="row"><span class="k">Preço de entrada</span><span class="v">${fmtMoney(r.preco_entrada)}</span></div>
              <div class="row"><span class="k">Preço atual</span><span class="v">${fmtMoney(r.preco_atual)}</span></div>
              <div class="row"><span class="k">Variação</span><span class="v ${classForPct(vp)}">${fmtPct(vp)}</span></div>
              ${optionalLevels(r)}
            </div>
          </article>`);
      }
      html.push(`</div>`);
      mount.innerHTML = html.join("");

      // Resumo sempre com TODAS as posições carregadas
      renderPortfolioSummaryFrom(STATE.rows);
    }

    async function loadAll(){
      const mount = document.getElementById("mount");
      mount.innerHTML = `<div class="empty">Carregando dados…</div>`;
      try{
        const results = await Promise.all(DATA_URLS.map(u => fetchJSON(u).catch(()=>[])));
        const merged = results.flatMap(j => Array.isArray(j) ? j : (j && Array.isArray(j.rows) ? j.rows : []));
        STATE.rows = normalize(merged);
        // document.getElementById("updated").textContent = `Atualizado a cada 5' (${lastFiveStamp()})`;
        render();
      }catch(e){
        mount.innerHTML = `<div class="empty">Falha ao carregar dados.</div>`;
        console.error(e);
      }
    }

    // Listeners
    document.getElementById("q").addEventListener("input", ev=>{ STATE.q = ev.target.value; render(); });
    document.getElementById("sort").addEventListener("change", ev=>{ STATE.sort = ev.target.value; render(); });

    // Boot
    loadAll();
  </script>
</body>
</html>
